name: "Release"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read
  pull-requests: read

jobs:
  create-draft-release:
    name: "Create Draft Release"
    runs-on: "ubuntu-latest"
    outputs:
      upload_url: ${{ steps.create-release.outputs.upload_url }}
      release_id: ${{ steps.create-release.outputs.id }}
    steps:
      - name: "Checkout the repository"
        uses: "actions/checkout@v6"

      - name: "Gather tag name and version"
        id: info
        shell: bash
        run: |
          {
            if [ -z '${{ inputs.version }}' ]; then
              echo >&2 "No version provided. Using the tag name as version."
              tag_name='${{ github.ref_name }}'
              echo "tag_name=${tag_name}"
              echo "version=${tag_name#v}" # Remove 'v' prefix if present
            else
              echo "version=${{ inputs.version }}"
              echo "tag_name=v${{ inputs.version }}"
            fi
          } | tee "$GITHUB_OUTPUT"

      - name: "Generate changelog"
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: ""
          args: --verbose --unreleased --strip=header --config-url=https://raw.githubusercontent.com/orhun/git-cliff/refs/heads/main/examples/github.toml
        env:
          GITHUB_REPO: ${{ github.repository }}
          GIT_CLIFF_TAG: ${{ steps.info.outputs.tag_name }}

      - name: "Get Latest Release for Comparison"
        id: latest_release
        shell: bash
        run: |
          # Get the latest release (marked as "Latest" in GitHub) for comparison
          echo "Fetching latest release from GitHub API..."

          # Use GitHub API to get the latest release
          LATEST_RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest")

          # Extract tag name from the response
          LATEST_TAG=$(echo "$LATEST_RELEASE_JSON" | jq -r '.tag_name // empty')

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "No latest release found, this might be the first release"
            echo "latest_tag=" >> "$GITHUB_OUTPUT"
            echo "has_latest=false" >> "$GITHUB_OUTPUT"
          else
            echo "Latest release tag: $LATEST_TAG"
            echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
            echo "has_latest=true" >> "$GITHUB_OUTPUT"
          fi

      - name: "Create Enhanced Release Notes"
        id: release_notes
        shell: bash
        run: |
          # Create enhanced release notes with installation instructions and features
          cat > release_notes.md << EOF
          ## ðŸŽ¤ Voice Replay Integration v${{ steps.info.outputs.version }}

          ### Installation

          #### Via HACS (Recommended)
          [![Add Repository](https://my.home-assistant.io/badges/hacs_repository.svg)](https://my.home-assistant.io/redirect/hacs_repository/?owner=chechirecat&repository=hass-voice-replay&category=integration)

          1. Click the badge above to add this repository to HACS
          2. Search for "Voice Replay" in HACS Integrations
          3. Install and restart Home Assistant
          4. Go to Settings â†’ Devices & Services â†’ Add Integration â†’ "Voice Replay"

          #### Manual Installation
          1. Download \`voice-replay.zip\` from this release
          2. Extract to your \`<config>/custom_components/\` folder
          3. Restart Home Assistant
          4. Add the integration via Settings â†’ Devices & Services

          ### Requirements
          * Home Assistant 2025.10.4 or newer
          * Voice Replay Card (install separately for frontend UI)

          ### Features
          * ðŸŽ¤ **Voice Recording API** - Record audio via browser and save to media players
          * ðŸ—£ï¸ **Text-to-Speech API** - Generate speech using Home Assistant's TTS services
          * ðŸ  **Multi-Room Audio** - Play on any media player in your home
          * âš™ï¸ **Configurable Settings** - Silence prepend, volume boost, and more
          * ðŸ” **Secure** - Built-in Home Assistant authentication
          * ðŸ“± **RESTful API** - Easy integration with custom cards and automations

          ### Configuration Options
          * **Prepend Silence**: Configurable 0-10 seconds to prevent audio cutoffs
          * **Volume Boost**: Optional volume increase during playback
          * **TTS Engine Selection**: Choose from available TTS engines
          * **Language & Voice**: Support for multiple languages and voices

          ### API Endpoints
          * \`/api/voice-replay/upload\` - Upload audio recordings and TTS requests
          * \`/api/voice-replay/media_players\` - Get available media players
          * \`/api/voice-replay/tts_config\` - Get TTS configuration

          ### Frontend Card
          **ðŸŽ¨ Looking for the Lovelace Card?** Install the companion frontend card:
          ðŸ‘‰ **[Voice Replay Card Repository](https://github.com/chechirecat/hass-voice-replay-card)** ðŸ‘ˆ

          ### What's Changed

          ### Need Help?
          * ðŸ“š [Documentation](https://github.com/chechirecat/hass-voice-replay/blob/main/README.md)
          * ðŸ› [Report Issues](https://github.com/chechirecat/hass-voice-replay/issues)
          * ðŸ’¬ [Discussions](https://github.com/chechirecat/hass-voice-replay/discussions)

          EOF

          # Add comparison URL based on latest release
          if [ "${{ steps.latest_release.outputs.has_latest }}" == "true" ]; then
            echo "**Full Changelog**: https://github.com/chechirecat/hass-voice-replay/compare/${{ steps.latest_release.outputs.latest_tag }}...${{ steps.info.outputs.tag_name }}" >> release_notes.md
          else
            echo "**Full Changelog**: https://github.com/chechirecat/hass-voice-replay/commits/${{ steps.info.outputs.tag_name }}" >> release_notes.md
          fi

      - name: "Determine release type"
        id: release-type
        shell: bash
        run: |
          version="${{ steps.info.outputs.version }}"
          echo "Checking version: $version"

          # Check if it's a prerelease based on version pattern
          if [[ "$version" =~ ^0\. ]]; then
            # Development versions (0.x.x) are prereleases
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "Release type: Development/Debug version (0.x.x) â†’ prerelease"
          elif [[ "$version" =~ -[0-9A-Za-z.-]+ ]]; then
            # Versions with suffixes (1.0.0-beta.1, 2.0.0-rc.1) are prereleases
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "Release type: Pre-release version (contains suffix) â†’ prerelease"
          else
            # Stable versions (1.0.0, 2.1.0) are full releases
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            echo "Release type: Stable version (1.x.x+) â†’ full release"
          fi

      - name: "Create Draft Release"
        id: create-release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: ${{ steps.release-type.outputs.is_prerelease }}
          body_path: release_notes.md
          tag_name: ${{ steps.info.outputs.tag_name }}
          target_commitish: '${{ github.sha }}'
          token: ${{ secrets.GITHUB_TOKEN }}

  prepare:
    needs: create-draft-release
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      domain: ${{ steps.info.outputs.domain }}
      component_dir: ${{ steps.info.outputs.component_dir }}
      hacs_filename: ${{ steps.info.outputs.hacs_filename }}
      version: ${{ steps.info.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gather information
        id: info
        shell: bash
        run: |
          {
            domain="$(yq -r -oj '.domain' custom_components/*/manifest.json)"
            if [ -z "$domain" ]; then
              echo >&2 "No domain found in manifest.json. Please check your custom component."
              exit 1
            fi
            hacs_filename="$(yq -r '.filename' hacs.json)"
            if [ -z "$hacs_filename" ]; then
              echo >&2 "No filename found in hacs.json. Please check your HACS configuration."
              exit 1
            fi

            echo "domain=${domain}"
            echo "component_dir=custom_components/${domain}"
            echo "hacs_filename=${hacs_filename}"

            if [ -z '${{ inputs.version }}' ]; then
              echo >&2 "No version provided. Using the tag name as version."
              tag_name='${{ github.ref_name }}'
              echo "version=${tag_name#v}" # Remove 'v' prefix if present
            else
              echo "version=${{ inputs.version }}"
            fi

          } | tee "$GITHUB_OUTPUT"

      - name: Sanity check
        shell: bash
        run: |
          # Ensure version matches semver (e.g., 1.2.3, 1.2.3-beta.1)
          if ! [[ "${{ steps.info.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Error: Version '${{ steps.info.outputs.version }}' does not match SemVer format (e.g., 1.2.3 or 1.2.3-beta.1)."
            exit 1
          fi

      - name: "Build the integration"
        shell: "bash"
        run: |
          # Update version
          yq -i -o json '.version="${{ steps.info.outputs.version }}"' '${{ steps.info.outputs.component_dir }}/manifest.json'
          # Archive
          cd '${{ steps.info.outputs.component_dir }}'
          zip '${{ steps.info.outputs.hacs_filename }}' -r ./

      - name: "Upload artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.info.outputs.hacs_filename }}
          path: '${{ steps.info.outputs.component_dir }}/${{ steps.info.outputs.hacs_filename }}'

  upload:
    needs: [create-draft-release, prepare]
    runs-on: ubuntu-latest
    name: "Upload Release Asset"
    steps:
      - name: "Download artifact"
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.prepare.outputs.hacs_filename }}
      - name: "Upload Release Asset"
        id: upload-asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ needs.prepare.outputs.hacs_filename }}
          token: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: [create-draft-release, upload]
    name: "Publish Release"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Publish Draft Release"
        id: publish-release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: '${{ needs.create-draft-release.outputs.release_id }}',
              draft: false,
            })
